Bootstrap: docker
From: pytorch/pytorch:2.8.0-cuda12.9-cudnn9-devel

%files
    requirements.txt /app/

%post
    # Set correct permissions for /tmp to fix apt-key errors
    chmod 1777 /tmp

    # Install basics
    apt-get update && apt-get install -y --no-install-recommends \
        build-essential \
        cmake \
        git \
        python3 \
        python3-pip \
        curl \
        ca-certificates
    ln -s /usr/bin/python3 /usr/bin/python

    # Use uv to create a virtual environment and install packages
    pip install uv

    # Create the /app directory and move into it
    mkdir -p /app
    cd /app

    # Now that we are in /app, the venv will be created at /app/.venv
    uv venv

    # Install all required packages into /app/.venv
    uv pip install --upgrade -r /app/requirements.txt

    # For llama-cpp-python with CMAKE_ARGS
    # REMOVING THIS INSTALLATION FOR NOW, AS I USE VLLM EVEN FOR GGUF FILES
    # uv pip install --no-cache-dir llama-cpp-python --config-settings="cmake.args=-DGGML_CUDA=on"

%environment
    # Add the venv to the PATH
    export PATH="/app/.venv/bin:$PATH"

    # Explicitly point to the correct cert bundle installed by ca-certificates
    export SSL_CERT_FILE="/etc/ssl/certs/ca-certificates.crt"

%labels
    Author alban.bornet@unige.ch
    Version 0.1
    Description "Gemini container with vllm installed using uv"
